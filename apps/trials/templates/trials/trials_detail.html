{% extends 'base.html' %}
{% load i18n lazysignup_tags %}
{% load permission_tags %}

{% load bootstrap4 %} {# import bootstrap4/bootstrap3 #}

{% block title %}
  Trial detail
{% endblock %}

{% block breadcrumb %}
    <div class="container">
        <ol class="breadcrumb my-4">
            <li class="breadcrumb-item"><a href="{% url 'trials:trials_list' %}">List trials</a></li>
            <li class="breadcrumb-item active" aria-current="page">Details of <strong>{{ trial.name }}</strong> </li>
        </ol>
{% endblock %}

{% block content %}
    <h2>Trial details</h2>
    <ul class="list-inline">
    {% can "change_trial" trial user=user as can_change_trial %}
    {% if can_change_trial %}
        <li class="list-inline-item"><a class="changelink" href="{% url 'trials:trials_update' trial.pk %}">Edit</a></li>
    {% else %}
        <li class="list-inline-item"><span class="isDisabled"><a class="changelink">Edit</a></span></li>
    {% endif %}
    {% can "delete_trial" trial user=user as can_delete_trial %}
    {% if can_delete_trial %}
        <li class="list-inline-item"><a class="deletelink" href="{% url 'trials:trials_delete' trial.pk%}">Delete</a></li>
    {% else %}
        <li class="list-inline-item"><span class="isDisabled"><a class="deletelink">Delete</a></span></li>
    {% endif %}
    </ul>
    <hr />
    <dl class="row">
        <dt class="col-sm-3">Trial name:</dt>
        <dd class="col-sm-9">{{ trial.name }}</dd>

        <dt class="col-sm-3">Study code:</dt>
        <dd class="col-sm-9">{{ trial.studyCode }}</dd>

        <dt class="col-sm-3">Description:</dt>        
        <dd class="col-sm-9">{{ trial.description|linebreaks }}</dd>

        <dt class="col-sm-3"><a href="https://clinicaltrials.gov/">ClinicalTrials.gov:</a></dt>        
        <dd class="col-sm-9">{{ trial.clinicalTrials }}</dd>

        <dt class="col-sm-3">EutraCT:</dt>        
        <dd class="col-sm-9">{{ trial.clinicalTrials }}</dd>

        <dt class="col-sm-3">Disease:</dt>        
        <dd class="col-sm-9">{{ trial.disease }}</dd>

        <dt class="col-sm-3">Created At:</dt>        
        <dd class="col-sm-9">{{ trial.createdAt }}</dd>

        <dt class="col-sm-3">Created by:</dt>        
        <dd class="col-sm-9">{{ trial.createdBy }}</dd>
    </dl>
    <hr />

    <h2>Documents</h2>
    <ul class="list-inline">
        {% if can_change_trial %}
            <li class="list-inline-item"><a class="addlink" href="{% url 'trials:trials_file_upload' trial.pk %}">Add file</a></li>
        {% else %}
            <li class="list-inline-item"><span class="isDisabled"><a class="addlink">Add file</a></span></li>
        {% endif %}
    </ul>
    {% if trial.document_set.all %}
        <table class="table">
            <thead class="thead-inverse">
                <tr>
                    <th></th>
                    <th>Document</th>
                    <th>Description</th>
                    <th>Uploaded at</th>
                    <th class="text-right">Uploaded by</th>

                </tr>
            </thead>
            {% for document in trial.document_set.all %}
                <tr>
                    <td>
                        {% if can_change_trial %}
                            <a class="viewdetailslink" href="{% url 'trials:trials_upload_detail' document.pk %}">Details</a>
                        {% else %}
                            <span class="isDisabled"><a class="viewdetailslink">Details</a></span>
                        {% endif %}
                    </td>
                    <td><a class="downloadlink" href="{{ document.document.url }}" target="blank">{{ document.filename }}</a></td>
                    <td>{{ document.description|linebreaks|truncatechars:150 }}</td>
                    <td>{{ document.uploaded_at }}</td>
                    <td class="text-right">{{ document.uploaded_by }}</td>
                    <td></td>
                </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>No documents available.</p>
    {% endif %}
    <hr />

    <h2>Permissions</h2>
    {% can "admin_trial" trial user=user as can_admin_trial %}
    <ul class="list-inline">
        {% if can_admin_trial %}
            <li class="list-inline-item"><a class="addlink" href="">Add permission</a></li>
        {% else %}
            <li class="list-inline-item"><span class="isDisabled"><a class="addlink">Add permission</a></span></li>
        {% endif %}
    </ul>
    {% if trial.trialpermission_set.all %}
        <p>In addition to the full access of the creator, access rights are set as follows.</p>
        <table class="table">
            <thead class="thead-inverse">
                <tr>
                    <th>User</th>
                    <th>Permission</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
        {% for permission in trial.trialpermission_set.all %}
            <tr>
                <td>{{ permission.user }}</td>
                <td>{{ permission.get_permission_display }}</td>
                {% if can_admin_trial %}
                    <td><a class="changelink" href="">Edit</a></td>
                    <td><a class="deletelink" href="">Delete</a></td>
                {% else %}
                    <td><span class="isDisabled"><a class="changelink">Edit</a></span></td>
                    <td><span class="isDisabled"><a class="deletelink">Delete</a></span></td>
                {% endif %}
            </tr>
        {% endfor %}
        </table>
    {% else %}
        <p>No further permissions available. Only the trial creator has full access.</p>
    {% endif %}
    <div class="alert alert-info" role="alert">
        At present, add, edit and delete permissions aren't implemented in frontend. Changes can be done by admins via Django admin site.
    </div>
    <hr />
    <h2>Standard views</h2>
    <ul>
        <li><a href={% url 'patients:patients_list' trial.pk %}>Patients list<a></li>
        <li><a href="">Patient data</a></li>
        <li><a href="{% url 'dbviews:sdv_diagnostic_values' trial.pk%}">Diagnostics</a></li>
        <li><a href="">Treatments</a></li>
        <li><a href="">Adverse Effects</a></li>
        <li><a href="">Evaluation</a></li>
    </ul>
    <hr />
    <h2>User defined views</h2>
    {% if trial.studyCode == "DESTINY" %}
        <ul>
            <li><a href={% url 'udv_destiny:cml_destiny_view1' %}>CML Destiny View bla<a></li>
            <li>View blu</li>
            <li>View blub</li>
        </ul>
    {% endif %}
{% endblock content %}